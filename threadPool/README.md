# ThreadPool File Transfer Server

ä¸€ä¸ªåŸºäºçº¿ç¨‹æ± æ¶æ„çš„é«˜æ€§èƒ½æ–‡ä»¶ä¼ è¾“æœåŠ¡å™¨ï¼Œæ”¯æŒé›¶æ‹·è´ä¼ è¾“ã€ä¼˜é›…é€€å‡ºå’Œå¹¶å‘å¤„ç†ã€‚

## ğŸ“‹ ç›®å½•

- [åŠŸèƒ½ç‰¹æ€§](#åŠŸèƒ½ç‰¹æ€§)
- [é¡¹ç›®æ¶æ„](#é¡¹ç›®æ¶æ„)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [ç¼–è¯‘æŒ‡å—](#ç¼–è¯‘æŒ‡å—)
- [ä½¿ç”¨è¯´æ˜](#ä½¿ç”¨è¯´æ˜)
- [åè®®è¯´æ˜](#åè®®è¯´æ˜)
- [APIæ–‡æ¡£](#apiæ–‡æ¡£)
- [æ€§èƒ½ç‰¹ç‚¹](#æ€§èƒ½ç‰¹ç‚¹)
- [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

### æœåŠ¡å™¨ç«¯
- **çº¿ç¨‹æ± æ¶æ„** - å¤šçº¿ç¨‹å¹¶å‘å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
- **é›¶æ‹·è´ä¼ è¾“** - ä½¿ç”¨mmapå†…å­˜æ˜ å°„æå‡æ–‡ä»¶ä¼ è¾“æ€§èƒ½
- **å°ç«è½¦åè®®** - å¯é çš„æ•°æ®åŒ…ä¼ è¾“åè®®
- **ä¼˜é›…é€€å‡º** - æ”¯æŒä¿¡å·é©±åŠ¨çš„å®‰å…¨å…³é—­
- **äº‹ä»¶é©±åŠ¨I/O** - åŸºäºepollçš„é«˜æ•ˆç½‘ç»œå¤„ç†
- **é”™è¯¯å¤„ç†** - å®Œå–„çš„é”™è¯¯æ£€æµ‹å’Œæ¢å¤æœºåˆ¶

### å®¢æˆ·ç«¯
- **æ–‡ä»¶ä¸‹è½½** - æ”¯æŒæŒ‡å®šæ–‡ä»¶åä¸‹è½½
- **è¿›åº¦æ˜¾ç¤º** - å®æ—¶æ˜¾ç¤ºä¸‹è½½è¿›åº¦
- **æ–­çº¿é‡è¿** - ç½‘ç»œå¼‚å¸¸æ—¶çš„é”™è¯¯å¤„ç†
- **æœ¬åœ°ä¿å­˜** - è‡ªåŠ¨é‡å‘½åé¿å…æ–‡ä»¶å†²çª

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

```
threadPool/
â”œâ”€â”€ server/              # æœåŠ¡å™¨ç«¯
â”‚   â”œâ”€â”€ main.c          # ä¸»ç¨‹åºå…¥å£å’Œä¿¡å·å¤„ç†
â”‚   â”œâ”€â”€ worker.c        # å·¥ä½œçº¿ç¨‹å®ç°
â”‚   â”œâ”€â”€ ThreadPool.c    # çº¿ç¨‹æ± ç®¡ç†
â”‚   â”œâ”€â”€ ThreadPool.h    # çº¿ç¨‹æ± å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ taskQueue.c     # ä»»åŠ¡é˜Ÿåˆ—å®ç°
â”‚   â”œâ”€â”€ taskQueue.h     # ä»»åŠ¡é˜Ÿåˆ—å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ tidArr.c        # çº¿ç¨‹IDæ•°ç»„ç®¡ç†
â”‚   â”œâ”€â”€ tidArr.h        # çº¿ç¨‹IDæ•°ç»„å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ transFile.c     # æ–‡ä»¶ä¼ è¾“å®ç°
â”‚   â”œâ”€â”€ epoll.c         # epolläº‹ä»¶å¤„ç†
â”‚   â”œâ”€â”€ initTcp.c       # TCPåˆå§‹åŒ–
â”‚   â””â”€â”€ Makefile        # æ„å»ºé…ç½®
â””â”€â”€ client/             # å®¢æˆ·ç«¯
    â”œâ”€â”€ client.c        # å®¢æˆ·ç«¯å®ç°
    â””â”€â”€ Makefile        # æ„å»ºé…ç½®
```

### æ ¸å¿ƒç»„ä»¶

#### 1. çº¿ç¨‹æ± ç®¡ç† (ThreadPool)
```c
typedef struct ThreadPool_s {
    tidArr_t tidArr;        // çº¿ç¨‹IDæ•°ç»„
    taskQueue_t taskQueue;  // ä»»åŠ¡é˜Ÿåˆ—
    pthread_mutex_t mutex;  // äº’æ–¥é”
    pthread_cond_t empty;   // æ¡ä»¶å˜é‡ï¼šé˜Ÿåˆ—ç©º
    pthread_cond_t full;    // æ¡ä»¶å˜é‡ï¼šé˜Ÿåˆ—æ»¡
    int exitFlag;           // é€€å‡ºæ ‡å¿—
    int exitPipe[2];        // é€€å‡ºç®¡é“
} ThreadPool_t;
```

#### 2. ä»»åŠ¡é˜Ÿåˆ— (TaskQueue)
```c
typedef struct taskQueue_s {
    node_t* front;      // é˜Ÿé¦–æŒ‡é’ˆ
    node_t* rear;       // é˜Ÿå°¾æŒ‡é’ˆ
    int queueSize;      // é˜Ÿåˆ—å¤§å°
} taskQueue_t;
```

#### 3. å°ç«è½¦åè®® (Train Protocol)
```c
typedef struct train_s {
    int len;            // æ•°æ®é•¿åº¦
    char data[1000];    // æ•°æ®å†…å®¹
} train_t;
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç³»ç»Ÿè¦æ±‚
- Linuxç³»ç»Ÿ (Ubuntu 18.04+)
- GCCç¼–è¯‘å™¨
- pthreadåº“
- è‡³å°‘1GBå¯ç”¨å†…å­˜

### å®‰è£…ä¾èµ–
```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install build-essential

# CentOS/RHEL
sudo yum groupinstall "Development Tools"
```

## ğŸ”¨ ç¼–è¯‘æŒ‡å—

### ç¼–è¯‘æœåŠ¡å™¨
```bash
cd threadPool/server
make clean          # æ¸…ç†æ—§æ–‡ä»¶
make                 # ç¼–è¯‘æœåŠ¡å™¨
```

### ç¼–è¯‘å®¢æˆ·ç«¯
```bash
cd threadPool/client
make clean          # æ¸…ç†æ—§æ–‡ä»¶
make                # ç¼–è¯‘å®¢æˆ·ç«¯
```

### æ¸…ç†æ‰€æœ‰
```bash
# åœ¨projectæ ¹ç›®å½•
cd threadPool/server && make clean
cd ../client && make clean
```

## ğŸ“– ä½¿ç”¨è¯´æ˜

### å¯åŠ¨æœåŠ¡å™¨
```bash
cd threadPool/server
./server <IPåœ°å€> <ç«¯å£> <çº¿ç¨‹æ•°>

# ç¤ºä¾‹
./server 127.0.0.1 8888 3      # æœ¬åœ°ç›‘å¬ï¼Œ3ä¸ªå·¥ä½œçº¿ç¨‹
./server 0.0.0.0 9999 5        # ç›‘å¬æ‰€æœ‰æ¥å£ï¼Œ5ä¸ªå·¥ä½œçº¿ç¨‹
```

**å‚æ•°è¯´æ˜ï¼š**
- `IPåœ°å€`: æœåŠ¡å™¨ç»‘å®šçš„IPåœ°å€
- `ç«¯å£`: ç›‘å¬ç«¯å£å·
- `çº¿ç¨‹æ•°`: å·¥ä½œçº¿ç¨‹æ•°é‡ï¼ˆå»ºè®®CPUæ ¸æ•°çš„2å€ï¼‰

### å®¢æˆ·ç«¯ä¸‹è½½æ–‡ä»¶
```bash
cd threadPool/client
./client <æœåŠ¡å™¨IP> <ç«¯å£> <æ–‡ä»¶å>

# ç¤ºä¾‹
./client 127.0.0.1 8888 testfile.txt
./client 192.168.1.100 9999 document.pdf
```

**å‚æ•°è¯´æ˜ï¼š**
- `æœåŠ¡å™¨IP`: ç›®æ ‡æœåŠ¡å™¨IPåœ°å€
- `ç«¯å£`: æœåŠ¡å™¨ç›‘å¬ç«¯å£
- `æ–‡ä»¶å`: è¦ä¸‹è½½çš„æ–‡ä»¶åï¼ˆæœåŠ¡å™¨ç«¯ç›¸å¯¹è·¯å¾„ï¼‰

### ä¼˜é›…é€€å‡ºæœåŠ¡å™¨
```bash
# æ–¹æ³•1ï¼šå‘é€ä¿¡å·
kill -SIGUSR1 <æœåŠ¡å™¨è¿›ç¨‹ID>

# æ–¹æ³•2ï¼šä½¿ç”¨Ctrl+C
# åœ¨æœåŠ¡å™¨è¿è¡Œç»ˆç«¯æŒ‰ Ctrl+C

# æ–¹æ³•3ï¼šä½¿ç”¨ç³»ç»Ÿä¿¡å·
pkill -SIGUSR1 server
```

## ğŸ“¡ åè®®è¯´æ˜

### å°ç«è½¦åè®®æ ¼å¼

#### 1. æ–‡ä»¶è¯·æ±‚é˜¶æ®µ
```
å®¢æˆ·ç«¯ -> æœåŠ¡å™¨:
[é•¿åº¦][æ–‡ä»¶å]

ç¤ºä¾‹ï¼š
[9]["test.txt"]
```

#### 2. æ–‡ä»¶å¤§å°ä¼ è¾“
```
æœåŠ¡å™¨ -> å®¢æˆ·ç«¯:
[é•¿åº¦][æ–‡ä»¶å¤§å°æ•°æ®]

ç¤ºä¾‹ï¼š
[8][æ–‡ä»¶å¤§å°ï¼š1024å­—èŠ‚]
```

#### 3. æ–‡ä»¶å†…å®¹ä¼ è¾“
```
æœåŠ¡å™¨ -> å®¢æˆ·ç«¯:
[é•¿åº¦][æ•°æ®å—] [é•¿åº¦][æ•°æ®å—] ... [0][]

è¯´æ˜ï¼š
- æ¯ä¸ªæ•°æ®å—æœ€å¤§1000å­—èŠ‚
- é•¿åº¦ä¸º0è¡¨ç¤ºä¼ è¾“ç»“æŸ
```

### é”™è¯¯å¤„ç†
- **æ–‡ä»¶ä¸å­˜åœ¨**: æœåŠ¡å™¨è¿”å›é•¿åº¦ä¸º0çš„åŒ…
- **ç½‘ç»œæ–­å¼€**: å®¢æˆ·ç«¯æ˜¾ç¤ºè¿æ¥é”™è¯¯
- **æƒé™ä¸è¶³**: æœåŠ¡å™¨è®°å½•é”™è¯¯æ—¥å¿—

## ğŸ“š APIæ–‡æ¡£

### æœåŠ¡å™¨ç«¯æ ¸å¿ƒå‡½æ•°

#### ThreadPoolç®¡ç†
```c
// åˆå§‹åŒ–çº¿ç¨‹æ± 
int ThreadPoolInit(ThreadPool_t* threadPool, int workerNum);

// åˆ›å»ºå·¥ä½œçº¿ç¨‹
int makeWorker(ThreadPool_t *threadPool);

// å·¥ä½œçº¿ç¨‹å‡½æ•°
void* worker(void* arg);
```

#### ä»»åŠ¡é˜Ÿåˆ—æ“ä½œ
```c
// åˆå§‹åŒ–ä»»åŠ¡é˜Ÿåˆ—
int taskQueueInit(taskQueue_t* taskQueue);

// å…¥é˜Ÿæ“ä½œ
int enQueue(taskQueue_t* taskQueue, int netfd);

// å‡ºé˜Ÿæ“ä½œ
int deQueue(taskQueue_t* taskQueue);
```

#### æ–‡ä»¶ä¼ è¾“
```c
// æ–‡ä»¶ä¼ è¾“ä¸»å‡½æ•°
int transFile(int netfd);
```

#### ç½‘ç»œæ“ä½œ
```c
// TCPåˆå§‹åŒ–
int initTcp(char *ip, char* port);

// epolläº‹ä»¶ç®¡ç†
int epollAdd(int epfd, int fd);
int epollDel(int epfd, int fd);
```

### å®¢æˆ·ç«¯æ ¸å¿ƒå‡½æ•°

```c
// å¯é æ¥æ”¶å‡½æ•°
int recvn(int sockfd, void *buf, int len);

// æ–‡ä»¶ä¸‹è½½å‡½æ•°
int sendFile(int netfd, char* filename);
```

## âš¡ æ€§èƒ½ç‰¹ç‚¹

### é›¶æ‹·è´ä¼ è¾“
- ä½¿ç”¨`mmap`å†…å­˜æ˜ å°„
- é¿å…ç”¨æˆ·æ€å’Œå†…æ ¸æ€æ•°æ®å¤åˆ¶
- å¤§æ–‡ä»¶ä¼ è¾“æ€§èƒ½æå‡æ˜¾è‘—

### å¹¶å‘å¤„ç†èƒ½åŠ›
- å¤šçº¿ç¨‹å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
- çº¿ç¨‹æ± é¿å…é¢‘ç¹åˆ›å»º/é”€æ¯çº¿ç¨‹
- æ”¯æŒé«˜å¹¶å‘è¿æ¥

### å†…å­˜ä¼˜åŒ–
- ä»»åŠ¡é˜Ÿåˆ—åŠ¨æ€ç®¡ç†
- åŠæ—¶é‡Šæ”¾ç½‘ç»œè¿æ¥èµ„æº
- åˆç†çš„ç¼“å†²åŒºå¤§å°è®¾è®¡

### æ€§èƒ½æ•°æ®
```
æµ‹è¯•ç¯å¢ƒï¼š4æ ¸CPU, 8GBå†…å­˜
æ–‡ä»¶å¤§å°ï¼š100MB
å¹¶å‘è¿æ¥ï¼š10ä¸ªå®¢æˆ·ç«¯

ä¼ è¾“é€Ÿåº¦ï¼š~85MB/s
CPUä½¿ç”¨ç‡ï¼š~30%
å†…å­˜ä½¿ç”¨ï¼š~50MB
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. ç¼–è¯‘é”™è¯¯
```bash
# é”™è¯¯ï¼šæ‰¾ä¸åˆ°my_header.h
# è§£å†³ï¼šæ£€æŸ¥ç³»ç»Ÿå¤´æ–‡ä»¶è·¯å¾„
ls /usr/include/my_header.h

# é”™è¯¯ï¼špthreadé“¾æ¥å¤±è´¥
# è§£å†³ï¼šç¡®ä¿ä½¿ç”¨-lpthreadé€‰é¡¹
gcc ... -lpthread
```

#### 2. è¿è¡Œæ—¶é”™è¯¯
```bash
# é”™è¯¯ï¼šbindå¤±è´¥ (Address already in use)
# è§£å†³ï¼šç­‰å¾…ç«¯å£é‡Šæ”¾æˆ–ä½¿ç”¨å…¶ä»–ç«¯å£
sudo netstat -tlnp | grep 8888
kill -9 <PID>

# é”™è¯¯ï¼šæƒé™ä¸è¶³
# è§£å†³ï¼šæ£€æŸ¥æ–‡ä»¶æƒé™
chmod 644 <æ–‡ä»¶å>
```

#### 3. è¿æ¥é—®é¢˜
```bash
# å®¢æˆ·ç«¯æ— æ³•è¿æ¥
# æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
ps aux | grep server

# æ£€æŸ¥ç«¯å£ç›‘å¬
sudo netstat -tlnp | grep <ç«¯å£>

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status
```

### è°ƒè¯•æŠ€å·§

#### 1. å¯ç”¨è°ƒè¯•ä¿¡æ¯
```bash
# ç¼–è¯‘æ—¶å¯ç”¨è°ƒè¯•
make CFLAGS="-g -DDEBUG"

# ä½¿ç”¨gdbè°ƒè¯•
gdb ./server
(gdb) run 127.0.0.1 8888 3
```

#### 2. æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
```bash
# æŸ¥çœ‹ç³»ç»Ÿæ¶ˆæ¯
dmesg | tail -n 50

# æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€
top -p <PID>
```

#### 3. ç½‘ç»œåˆ†æ
```bash
# æŠ“åŒ…åˆ†æ
sudo tcpdump -i lo port 8888

# è¿æ¥çŠ¶æ€
ss -tuln | grep 8888
```

## ğŸ“ å¼€å‘è¯´æ˜

### ä»£ç é£æ ¼
- ä½¿ç”¨4ç©ºæ ¼ç¼©è¿›
- å‡½æ•°å‘½åé‡‡ç”¨é©¼å³°å¼
- å˜é‡å‘½åç®€æ´æ˜äº†
- å……åˆ†çš„é”™è¯¯æ£€æŸ¥

### æ‰©å±•å»ºè®®
1. **SSL/TLSæ”¯æŒ** - æ·»åŠ åŠ å¯†ä¼ è¾“
2. **é…ç½®æ–‡ä»¶** - æ”¯æŒé…ç½®æ–‡ä»¶å¯åŠ¨
3. **æ—¥å¿—ç³»ç»Ÿ** - å®Œå–„çš„æ—¥å¿—è®°å½•
4. **æ–­ç‚¹ç»­ä¼ ** - æ”¯æŒå¤§æ–‡ä»¶æ–­ç‚¹ç»­ä¼ 
5. **ç”¨æˆ·è®¤è¯** - æ·»åŠ ç”¨æˆ·æƒé™æ§åˆ¶

### è´¡çŒ®æŒ‡å—
1. Forké¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. å‘èµ·Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ï¼Œè¯¦è§LICENSEæ–‡ä»¶ã€‚

## ğŸ‘¥ ä½œè€…

- é¡¹ç›®å¼€å‘ï¼šKuansiu Built With Claude Code Assistant
- å‚è€ƒå®ç°ï¼šprocessPool1é¡¹ç›®

## ğŸ™ è‡´è°¢

æ„Ÿè°¢æ‰€æœ‰ä¸ºè¯¥é¡¹ç›®æä¾›å»ºè®®å’Œåé¦ˆçš„å¼€å‘è€…ã€‚